# Basic Squid configuration for proxy with authentication
# Port configuration
http_port 3128

# Authentication configuration
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/auth/htpasswd
auth_param basic children 5
auth_param basic realm Server
auth_param basic credentialsttl 2 hours
auth_param basic casesensitive on

# Access control lists
acl authenticated proxy_auth REQUIRED
acl SSL_ports port 443
acl SSL_ports port 8443          # alternative HTTPS
acl SSL_ports port 993           # IMAPS  
acl SSL_ports port 995           # POP3S
acl Safe_ports port 80           # http
acl Safe_ports port 21           # ftp
acl Safe_ports port 443          # https
acl Safe_ports port 70           # gopher
acl Safe_ports port 210          # wais
acl Safe_ports port 1025-65535   # unregistered ports
acl Safe_ports port 280          # http-mgmt
acl Safe_ports port 488          # gss-http
acl Safe_ports port 591          # filemaker
acl Safe_ports port 777          # multiling http
acl Safe_ports port 8080         # common http alt
acl Safe_ports port 8443         # common https alt
acl CONNECT method CONNECT

# Security ACLs to prevent SSRF and internal network access
acl to_localhost dst 127.0.0.0/8
acl to_private_networks dst 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
acl to_link_local dst 169.254.0.0/16
acl to_multicast dst 224.0.0.0/4

# Access rules
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
# Deny access to internal networks and localhost (SSRF protection)
http_access deny to_localhost
http_access deny to_private_networks
http_access deny to_link_local
http_access deny to_multicast
http_access deny manager
http_access allow authenticated
http_access deny all

# Remove client information to ensure anonymity
# Strip forwarded headers and client identification
forwarded_for off
via off

# Remove identifying headers from requests
request_header_access X-Forwarded-For deny all
request_header_access X-Real-IP deny all
request_header_access X-Client-IP deny all
request_header_access Client-IP deny all
request_header_access Remote-Addr deny all
request_header_access Remote-Host deny all
request_header_access User-Agent allow all
request_header_access From deny all
request_header_access Referer deny all
request_header_access Server deny all
request_header_access Link deny all
request_header_access X-Forwarded-Server deny all
request_header_access X-Forwarded-Host deny all

# Remove proxy-identifying headers from responses
reply_header_access X-Cache deny all
reply_header_access X-Cache-Lookup deny all
reply_header_access X-Served-By deny all
reply_header_access X-Proxy deny all

# Cache configuration
cache deny all
cache_mem 0 MB
maximum_object_size_in_memory 0 KB
maximum_object_size 0 MB

# Log configuration  
access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log

# Coredump directory
coredump_dir /var/cache/squid

# DNS settings
dns_nameservers 1.1.1.1 1.0.0.1

# Disable unnecessary features
httpd_suppress_version_string on
visible_hostname proxy-server

# Hide server identity completely
reply_header_access Server deny all
reply_header_access X-Cache deny all
reply_header_access X-Cache-Lookup deny all
reply_header_access Via deny all
reply_header_access X-Forwarded-For deny all
reply_header_access X-Squid-Error deny all

# Disable error page customization to avoid Squid identification
error_default_language en

# Return TCP reset instead of error pages for most denials
deny_info TCP_RESET to_localhost
deny_info TCP_RESET to_private_networks
deny_info TCP_RESET to_link_local
deny_info TCP_RESET to_multicast

# Connection settings
connect_timeout 60 seconds
request_timeout 60 seconds

# Refresh patterns for better caching
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# Additional stealth configurations
# Disable ICAP and eCAP to avoid identification
icap_enable off
ecap_enable off

# Disable unnecessary protocols that could leak identity
icp_port 0
htcp_port 0

# Hide administrative interface completely
cachemgr_passwd disable all

# Disable SNMP agent
snmp_port 0

# Additional response header removal for stealth
reply_header_access X-Squid-Error deny all
reply_header_access X-Cache-Remote deny all
reply_header_access X-Cache-Status deny all
reply_header_access Age allow all
reply_header_access Cache-Control allow all
reply_header_access Content-Type allow all
reply_header_access Date allow all
reply_header_access Expires allow all
reply_header_access Last-Modified allow all
